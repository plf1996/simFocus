# simFocus 系统架构设计

**版本**: v1.0
**日期**: 2026-02-03
**状态**: 架构设计文档

---

## 目录

1. [系统概述](#1-系统概述)
2. [架构原则](#2-架构原则)
3. [系统架构](#3-系统架构)
4. [技术架构](#4-技术架构)
5. [数据架构](#5-数据架构)
6. [安全架构](#6-安全架构)
7. [部署架构](#7-部署架构)
8. [演进规划](#8-演进规划)

---

## 1. 系统概述

### 1.1 产品定位

simFocus 是一个 AI 驱动的虚拟焦点小组平台，通过模拟多角色实时讨论，为用户提供多元视角、深度洞察和创意灵想的思维辅助工具。

### 1.2 核心价值

- **多视角碰撞**：单次讨论获取 3-7 个不同角色观点
- **实时观摩体验**：观察观点形成、碰撞、演化的全过程
- **智能角色系统**：支持自定义角色或 AI 自动生成最优讨论参与者
- **深度思考外化**：可视化和结构化复杂论证过程
- **隐私可控**：用户自备 API 密钥，数据本地存储

### 1.3 目标用户

- 知识工作者（独立开发者、自由职业者、研究人员）
- 产品团队（产品经理、UX 研究员、市场研究员）
- 教育领域（学生、教师、学术研究人员）
- 创意行业（设计师、文案、营销人员）

---

## 2. 架构原则

### 2.1 设计原则

1. **分层解耦**：前后端分离，服务层与数据层分离
2. **异步优先**：使用异步 I/O 处理高并发场景
3. **状态管理**：服务端无状态设计，状态存储在 Redis 中
4. **可扩展性**：支持水平扩展，模块化设计
5. **安全性优先**：数据加密、认证授权、隐私保护

### 2.2 技术选型原则

- **成熟稳定**：选择经过验证的开源技术栈
- **社区活跃**：确保长期维护和问题解决能力
- **性能优先**：满足高并发和低延迟需求
- **开发效率**：提供良好的开发体验和工具链

---

## 3. 系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │         前端 (Vue 3 + Pinia + Socket.IO)                  │ │
│  │  - 视图层: Vue Components                                  │ │
│  │  - 状态管理: Pinia Stores                                  │ │
│  │  - 路由: Vue Router                                        │ │
│  │  - 实时通信: Socket.IO Client                              │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 │ HTTPS/WSS
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                         应用层                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              API 网关 (FastAPI)                            │ │
│  │  - 认证授权 (JWT)                                          │ │
│  │  - 速率限制                                                │ │
│  │  - 请求路由                                                │ │
│  │  - CORS 处理                                               │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                 │                                │
│           ┌─────────────────────┼─────────────────────┐         │
│           ▼                     ▼                     ▼         │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │
│  │  REST API      │  │   WebSocket    │  │ Background     │    │
│  │  Endpoints     │  │   Handler      │  │ Workers        │    │
│  └────────────────┘  └────────────────┘  └────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                         服务层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │
│  │  User        │  │  Character   │  │  Discussion          │ │
│  │  Service     │  │  Service     │  │  Engine Service      │ │
│  └──────────────┘  └──────────────┘  └──────────────────────┘ │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │
│  │  Topic       │  │  Report      │  │  LLM Orchestrator    │ │
│  │  Service     │  │  Generator   │  │  Service             │ │
│  └──────────────┘  └──────────────┘  └──────────────────────┘ │
│  ┌──────────────┐  ┌──────────────┐                           │
│  │  API Key     │  │  Embedding   │                           │
│  │  Service     │  │  Service     │                           │
│  └──────────────┘  └──────────────┘                           │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                       外部服务层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │
│  │  OpenAI API  │  │  Anthropic   │  │  OpenAI-Compatible   │ │
│  │  (用户密钥)  │  │  API         │  │  APIs                │ │
│  └──────────────┘  └──────────────┘  └──────────────────────┘ │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │           Keycloak SSO (单点登录服务)                      │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐ │
│  │ PostgreSQL   │  │    Redis     │  │  向量数据库 (P2)      │ │
│  │ (主数据库)   │  │ (缓存 +      │  │  - 角色记忆           │ │
│  │              │  │  Pub/Sub)    │  │  - 语义检索           │ │
│  └──────────────┘  └──────────────┘  └──────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 层次职责

#### 3.2.1 客户端层

**职责**：用户交互界面，状态管理，实时通信

**技术栈**：
- Vue 3 (Composition API)
- Pinia (状态管理)
- Vue Router 4 (路由)
- Tailwind CSS (样式)
- Socket.IO Client (实时通信)
- Axios (HTTP 客户端)
- Keycloak JS (SSO 集成)

**关键功能**：
- 用户界面渲染
- 用户状态管理（认证信息、用户偏好）
- 实时讨论观摩（WebSocket 连接）
- API 调用封装
- 路由权限控制

#### 3.2.2 应用层

**职责**：请求处理、认证授权、协议转换

**技术栈**：
- FastAPI (异步 Web 框架)
- WebSocket (实时双向通信)
- Uvicorn (ASGI 服务器)

**关键组件**：

1. **API 网关**
   - JWT 令牌验证
   - 请求速率限制
   - CORS 处理
   - 请求日志记录

2. **REST API 端点**
   - 认证授权：`/api/auth/*`
   - 用户管理：`/api/users/*`
   - 议题管理：`/api/topics/*`
   - 角色管理：`/api/characters/*`
   - 讨论管理：`/api/discussions/*`
   - 报告生成：`/api/reports/*`

3. **WebSocket 处理器**
   - 连接生命周期管理
   - 消息广播
   - 控制命令处理（暂停、恢复、注入问题）
   - Redis Pub/Sub 集成（水平扩展）

4. **后台任务**
   - 报告生成
   - 邮件通知
   - 数据归档
   - 分析处理

#### 3.2.3 服务层

**职责**：业务逻辑实现、领域模型管理

**核心服务**：

1. **讨论引擎服务 (Discussion Engine)**
   - 协调多角色讨论
   - 管理讨论状态机
   - 处理 LLM 流式响应
   - 实现讨论模式（自由、结构化、创意、共识）

2. **LLM 编排服务 (LLM Orchestrator)**
   - 抽象多厂商 LLM 集成
   - 自动重试与退避
   - 速率限制
   - 成本追踪
   - 令牌使用优化

3. **用户服务 (User Service)**
   - 用户认证与授权
   - API 密钥加密/解密 (AES-256)
   - 用户偏好管理
   - 使用统计追踪

4. **角色服务 (Character Service)**
   - 角色模板管理
   - 角色推荐算法
   - 角色评分与流行度追踪

5. **报告生成服务 (Report Generator)**
   - 多段式报告生成
   - 可视化数据准备
   - 多格式导出（PDF、Markdown、JSON）

6. **嵌入服务 (Embedding Service)**
   - 文本向量化
   - 语义相似度计算
   - 角色智能推荐

#### 3.2.4 外部服务层

**职责**：集成第三方服务

**集成服务**：
- OpenAI API (GPT-4, GPT-3.5)
- Anthropic API (Claude)
- OpenAI 兼容 API（本地模型）
- Keycloak SSO（企业单点登录）

#### 3.2.5 数据层

**职责**：数据持久化、缓存、检索

**存储组件**：
- PostgreSQL 15（关系型数据库）
- Redis 7（缓存 + Pub/Sub）
- 向量数据库（P2 功能）

---

## 4. 技术架构

### 4.1 后端技术栈

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| Web 框架 | FastAPI | Latest | 高性能异步 API |
| 数据库 | PostgreSQL | 15 | 主数据存储 |
| 缓存 | Redis | 7 | 会话、缓存、Pub/Sub |
| ORM | SQLAlchemy | Latest | 数据库抽象 |
| 异步驱动 | asyncpg | Latest | PostgreSQL 异步驱动 |
| 认证 | JWT | - | 令牌认证 |
| 加密 | cryptography | - | AES-256-GCM 加密 |
| WebSocket | FastAPI WebSocket | - | 实时通信 |
| ASGI 服务器 | Uvicorn | Latest | 异步服务器 |
| SSO | python-keycloak | Latest | Keycloak 集成 |

### 4.2 前端技术栈

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 框架 | Vue | 3.4 | 渐进式前端框架 |
| 状态管理 | Pinia | 2.1 | 状态管理 |
| 路由 | Vue Router | 4.2 | 客户端路由 |
| 样式 | Tailwind CSS | 3.4 | 原子化 CSS |
| HTTP 客户端 | Axios | 1.6 | HTTP 请求 |
| WebSocket | Socket.IO Client | 4.6 | 实时通信 |
| 图标 | Heroicons | 2.1 | 图标库 |
| Markdown | marked | 17.0 | Markdown 渲染 |
| SSO | keycloak-js | 24.0 | Keycloak 集成 |
| 构建工具 | Vite | 5.0 | 快速构建 |

### 4.3 基础设施

| 组件 | 技术 | 用途 |
|------|------|------|
| 容器化 | Docker | 应用容器化 |
| 编排 | Docker Compose | 本地开发环境 |
| 反向代理 | Nginx | 生产环境代理 |
| 监控 | Prometheus + Grafana | 监控与可视化 |
| 日志 | ELK Stack | 日志聚合分析 |

---

## 5. 数据架构

### 5.1 数据库设计

#### 5.1.1 核心数据实体

```
users (用户表)
├── id: UUID (PK)
├── email: VARCHAR(255) UNIQUE
├── password_hash: VARCHAR(255)
├── name: VARCHAR(100)
├── auth_provider: VARCHAR(50)  -- 'email', 'keycloak'
└── created_at: TIMESTAMP

user_api_keys (用户 API 密钥)
├── id: UUID (PK)
├── user_id: UUID (FK)
├── provider: VARCHAR(50)  -- 'openai', 'anthropic'
├── encrypted_key: TEXT  -- AES-256 加密
└── is_active: BOOLEAN

topics (议题表)
├── id: UUID (PK)
├── user_id: UUID (FK)
├── title: VARCHAR(200)
├── description: TEXT
├── context: TEXT
└── status: VARCHAR(20)

characters (角色表)
├── id: UUID (PK)
├── user_id: UUID (FK)  -- NULL 表示系统预设
├── name: VARCHAR(100)
├── is_template: BOOLEAN
├── config: JSONB  -- 角色配置
└── rating_avg: DECIMAL

discussions (讨论会话表)
├── id: UUID (PK)
├── topic_id: UUID (FK)
├── user_id: UUID (FK)
├── discussion_mode: VARCHAR(20)
├── status: VARCHAR(20)
├── current_round: INTEGER
├── llm_provider: VARCHAR(50)
└── total_tokens_used: INTEGER

discussion_messages (讨论消息表)
├── id: UUID (PK)
├── discussion_id: UUID (FK)
├── participant_id: UUID (FK)
├── round: INTEGER
├── content: TEXT
└── created_at: TIMESTAMP

reports (报告表)
├── id: UUID (PK)
├── discussion_id: UUID (FK) UNIQUE
├── overview: JSONB
├── viewpoints_summary: JSONB
├── consensus: JSONB
├── controversies: JSONB
└── insights: JSONB
```

### 5.2 缓存策略

#### 5.2.1 Redis 缓存层次

1. **会话缓存** (TTL: 24 小时)
   - Key: `session:{session_id}`
   - Value: 用户会话数据、JWT 令牌

2. **用户配置缓存** (TTL: 1 小时)
   - Key: `user:{user_id}:profile`
   - Value: 用户配置、偏好

3. **API 密钥缓存** (TTL: 1 小时，加密)
   - Key: `user_api_keys:{user_id}`
   - Value: 活跃 API 密钥

4. **讨论状态缓存** (TTL: 讨论持续时间 + 1 小时)
   - Key: `discussion_state:{discussion_id}`
   - Value: 当前轮次、阶段、参与者

5. **角色模板缓存** (TTL: 24 小时)
   - Key: `character_template:{template_id}`
   - Value: 角色配置 JSON

6. **速率限制** (TTL: 窗口持续时间)
   - Key: `ratelimit:{user_id}:{endpoint}`
   - Value: 当前窗口请求计数

7. **WebSocket 连接追踪**
   - Key: `ws_connections:{discussion_id}:{user_id}`
   - Value: 连接元数据、服务器实例 ID

#### 5.2.2 缓存失效策略

- **Write-through**：同步写入缓存和数据库（关键数据）
- **Write-back**：先写缓存，异步持久化（高频数据）
- **时间过期**：基于 TTL 的自动淘汰
- **事件失效**：数据更新时发布失效事件

---

## 6. 安全架构

### 6.1 认证与授权

#### 6.1.1 认证方式

1. **邮箱 + 密码认证**
   - 密码使用哈希存储 (bcrypt)
   - JWT 令牌（24 小时有效期）
   - 刷新令牌机制

2. **Keycloak SSO**
   - OAuth 2.0 / OpenID Connect
   - 企业单点登录
   - 统一身份管理

#### 6.1.2 授权模型

- **基于用户的访问控制**：用户只能访问自己的讨论记录
- **基于角色的访问控制**：团队功能支持细粒度权限控制
- **分享链接**：支持密码保护和有效期限制

### 6.2 数据安全

#### 6.2.1 加密策略

1. **传输加密**
   - HTTPS/WSS (TLS 1.3)
   - 所有通信加密

2. **存储加密**
   - API 密钥：AES-256-GCM
   - 32 字节主密钥（环境变量）
   - 数据库加密（静态加密）

3. **密钥管理**
   - 主密钥年度轮换
   - 生产环境建议使用 AWS KMS 或 HashiCorp Vault

#### 6.2.2 隐私保护

- **数据最小化**：不收集不必要的数据
- **用户控制**：支持数据导出和删除
- **合规性**：符合 GDPR、CCPA 要求
- **审计日志**：敏感操作记录

### 6.3 安全机制

1. **速率限制**
   - 基于 Redis 的令牌桶算法
   - 每用户、每端点限制
   - IP 级别限制

2. **内容审核**
   - 本地关键词过滤
   - 正则表达式匹配
   - LLM 辅助审核（可选）

3. **安全审计**
   - 季度安全扫描
   - 依赖漏洞扫描
   - 安全事件响应

---

## 7. 部署架构

### 7.1 容器化部署

#### 7.1.1 服务组件

```
┌─────────────────────────────────────────────────────────────┐
│                      Docker Compose                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  frontend    │  │   backend    │  │   postgres   │     │
│  │  :3000       │  │   :8000      │  │   :5432      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐                       │
│  │    redis     │  │   keycloak   │  (外部服务)          │
│  │   :6379      │  │   (外部)     │                       │
│  └──────────────┘  └──────────────┘                       │
└─────────────────────────────────────────────────────────────┘
```

#### 7.1.2 网络架构

- **前端**：暴露端口 3000
- **后端**：暴露端口 8000
- **数据库**：内部网络
- **Redis**：内部网络
- **Keycloak**：外部服务

### 7.2 生产环境

#### 7.2.1 推荐架构

```
                        ┌─────────────┐
                        │   Nginx     │
                        │  (反向代理)  │
                        └──────┬──────┘
                               │
              ┌────────────────┼────────────────┐
              ▼                ▼                ▼
       ┌───────────┐    ┌───────────┐    ┌───────────┐
       │  Frontend │    │  Backend  │    │  Backend  │
       │   (CDN)   │    │  Instance │    │  Instance │
       └───────────┘    └─────┬─────┘    └─────┬─────┘
                              │                │
              ┌───────────────┼────────────────┼──────────┐
              ▼               ▼                ▼          ▼
       ┌───────────┐   ┌───────────┐   ┌───────────┐ ┌──────┐
       │PostgreSQL │   │   Redis   │   │   Redis   │ │外部 │
       │  Primary  │   │  Master   │   │  Replica  │ │服务  │
       └─────┬─────┘   └─────┬─────┘   └───────────┘ └──────┘
             │               │
             ▼               ▼
       ┌───────────┐   ┌───────────┐
       │PostgreSQL │   │   Redis   │
       │  Standby  │   │  Cluster  │
       └───────────┘   └───────────┘
```

#### 7.2.2 扩展策略

1. **水平扩展**
   - 无状态后端实例
   - Redis Pub/Sub 支持多实例
   - 负载均衡（Nginx）

2. **垂直扩展**
   - 数据库主从复制
   - Redis 集群
   - 连接池优化

### 7.3 监控与运维

#### 7.3.1 监控指标

- **应用指标**：请求量、响应时间、错误率
- **业务指标**：讨论完成率、API 使用量
- **系统指标**：CPU、内存、磁盘、网络

#### 7.3.2 日志管理

- **集中化日志**：ELK Stack
- **日志级别**：DEBUG、INFO、WARNING、ERROR
- **审计日志**：敏感操作记录

---

## 8. 演进规划

### 8.1 MVP 阶段（当前）

**核心能力**：
- 单用户模式
- 基础讨论功能
- 邮箱认证 + Keycloak SSO
- OpenAI API 集成

**架构特点**：
- 单体应用
- Docker Compose 部署
- 基础缓存策略

### 8.2 V1.1 - V1.2 阶段

**新增能力**：
- 多 LLM 支持
- 智能角色推荐
- 高级讨论控制
- 报告导出

**架构演进**：
- 引入向量数据库
- 优化缓存策略
- 增强 API 抽象层

### 8.3 V2.0 阶段

**新增能力**：
- 团队协作
- 讨论质量评分
- 话题智能分析

**架构演进**：
- 微服务拆分（讨论服务、用户服务、报告服务）
- 引入消息队列（Celery/RabbitMQ）
- 数据库读写分离

### 8.4 V3.0 阶段

**新增能力**：
- 角色市场
- 开放 API 平台
- 插件系统

**架构演进**：
- 服务网格（Istio）
- 多区域部署
- 高可用架构

---

## 附录

### A. 技术选型理由

**FastAPI vs Flask/Django**
- 原生异步支持
- 自动 API 文档
- 类型提示与 Pydantic 集成
- 高性能（媲美 Node.js）

**Vue 3 vs React**
- Composition API 更适合复杂状态管理
- 更小的打包体积
- 优秀的 TypeScript 支持
- 更简单的 API

**PostgreSQL vs MySQL**
- ACID 合规性
- JSONB 灵活性
- pgvector 扩展
- 全文搜索

**Redis vs Memcached**
- 数据结构丰富
- Pub/Sub 支持
- 持久化选项
- 高可用性

### B. 架构决策记录 (ADR)

**ADR-001: 选择 WebSocket 而非轮询**
- 理由：实时性要求高，降低服务器负载
- 影响：需要实现连接管理和重连机制

**ADR-002: 用户自备 API 密钥**
- 理由：降低平台成本，提升隐私保护
- 影响：需要实现加密存储和多厂商支持

**ADR-003: 采用 Keycloak SSO**
- 理由：企业用户需求，统一身份管理
- 影响：增加集成复杂度，但提升企业友好性

### C. 风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| LLM API 不稳定 | 高 | 中 | 多厂商支持，重试机制 |
| 讨论质量不达预期 | 高 | 中 | 持续优化 Prompt，用户反馈 |
| 并发性能瓶颈 | 中 | 低 | 水平扩展，缓存优化 |
| 数据泄露 | 高 | 低 | 加密存储，安全审计 |

---

**文档维护**：本文档随架构演进持续更新

**变更历史**：

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0 | 2026-02-03 | 初始版本，整体架构设计 |
